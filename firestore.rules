rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =============================================
    // Helper Functions
    // =============================================

    // Check if the request is from an authenticated user
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the authenticated user owns the document by userId
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Get the role field from the current user's document
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Check if the authenticated user has a specific role
    function isRole(role) {
      return isAuthenticated() && getUserRole() == role;
    }

    // Check if the authenticated user has any of the specified roles
    function hasRole(roles) {
      return isAuthenticated() && getUserRole() in roles;
    }

    // Check if the user is a staff member (organizer, security, or emergency)
    function isStaff() {
      return hasRole(['organizer', 'security', 'emergency']);
    }

    // =============================================
    // Users Collection
    // =============================================
    match /users/{userId} {
      // Users can read their own profile
      // Organizers can read all user profiles
      // Security and Emergency can read staff user profiles
      allow read: if isOwner(userId)
        || isRole('organizer')
        || (hasRole(['security', 'emergency'])
            && get(/databases/$(database)/documents/users/$(userId)).data.role in ['organizer', 'security', 'emergency']);

      // Users can create their own profile during registration
      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Users can update their own profile (but cannot change their role)
      // Organizers can update any user profile (including role changes)
      allow update: if (isOwner(userId)
            && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']))
        || isRole('organizer');
    }

    // =============================================
    // Events Collection
    // =============================================
    match /events/{eventId} {
      // Any authenticated user can read events
      allow read: if isAuthenticated();

      // Only organizers can create and update events
      allow create, update: if isRole('organizer');
    }

    // =============================================
    // Venues Collection
    // =============================================
    match /venues/{venueId} {
      // Any authenticated user can read venues
      allow read: if isAuthenticated();

      // Only organizers can create and update venues
      allow create, update: if isRole('organizer');
    }

    // =============================================
    // Zones Collection
    // =============================================
    match /zones/{zoneId} {
      // Any authenticated user can read zones
      allow read: if isAuthenticated();

      // Only organizers can create and update zones
      allow create, update: if isRole('organizer');
    }

    // =============================================
    // Crowd Density Collection
    // =============================================
    match /crowd_density/{densityId} {
      // Any authenticated user can read crowd density data
      allow read: if isAuthenticated();

      // Only organizers can write crowd density data from the client
      // Cloud Functions (admin SDK) bypass these rules entirely
      allow create, update: if isRole('organizer');
    }

    // =============================================
    // Incidents Collection
    // =============================================
    match /incidents/{incidentId} {
      // Any authenticated user can read incidents
      allow read: if isAuthenticated();

      // Security, Emergency, and Organizer roles can create incidents
      allow create: if hasRole(['security', 'emergency', 'organizer']);

      // Organizer and Emergency can update incident status
      allow update: if hasRole(['organizer', 'emergency']);

      // Only organizers can delete incidents
      allow delete: if isRole('organizer');
    }

    // =============================================
    // Alerts Collection
    // =============================================
    match /alerts/{alertId} {
      // Users can read alerts where their role is in the targetRoles array
      allow read: if isAuthenticated()
        && getUserRole() in resource.data.targetRoles;

      // Organizers can read all alerts regardless of targetRoles
      allow read: if isRole('organizer');

      // Only organizers can create, update, and delete alerts
      allow create, update, delete: if isRole('organizer');
    }

    // =============================================
    // Location History Collection
    // =============================================
    match /location_history/{locationId} {
      // Only the user themselves can write their own location data
      allow create, update: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      // Only organizers, security, and Cloud Functions can read location data
      // Cloud Functions (admin SDK) bypass these rules entirely
      allow read: if hasRole(['organizer', 'security']);
    }

    // =============================================
    // Staff Assignments Collection
    // =============================================
    match /staff_assignments/{assignmentId} {
      // Organizers can perform all CRUD operations on staff assignments
      allow read, create, update, delete: if isRole('organizer');

      // Security and Emergency can read their own assignments
      allow read: if hasRole(['security', 'emergency'])
        && resource.data.staffId == request.auth.uid;
    }

    // =============================================
    // Messages Collection
    // =============================================
    match /messages/{messageId} {
      // Staff roles (organizer, security, emergency) can read and write messages
      // Fans cannot access messages
      allow read, create, update: if hasRole(['organizer', 'security', 'emergency']);

      // Only organizers can delete messages
      allow delete: if isRole('organizer');
    }

    // =============================================
    // Notifications Collection
    // =============================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      // Users can update their own notifications (e.g., mark as read)
      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      // System creates notifications via Cloud Functions (admin SDK)
      // Allow organizers to create notifications from client as fallback
      allow create: if isRole('organizer');
    }

    // =============================================
    // Analytics Collection
    // =============================================
    match /analytics/{analyticsId} {
      // Only organizers can read and write analytics data
      allow read, write: if isRole('organizer');
    }

    // =============================================
    // Facilities Collection
    // =============================================
    match /facilities/{facilityId} {
      // Any authenticated user can read facilities
      allow read: if isAuthenticated();

      // Only organizers can write (create, update, delete) facilities
      allow write: if isRole('organizer');
    }
  }
}
